<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: inline-resource-md5.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: inline-resource-md5.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file 为内联引用的资源文件生成 md5 版本号信息的处理器
 * @author wuhuiyao
 */

var util = require('./util');

/**
 * 扫描特定的资源类型的文件
 *
 * @param {Array.&lt;Object>} scanFiles 要扫描的文件
 * @param {Array.&lt;string>} resourceSuffixs 要扫描的资源文件的后缀名
 *  @return {Array.&lt;Object>} 扫描到资源文件要添加到的目标数组
 */
function scanResourceFiles(scanFiles, resourceSuffixs) {
    var found = [];

    for (var i = 0, len = scanFiles.length; i &lt; len; i++) {
        var file = scanFiles[i];

        if (util.isFileTypeOf(file.extname, resourceSuffixs)) {
            found.push(file);
        }
    }

    return found;
}

/**
 * 为图片文件生成版本号信息
 *
 * @param {Versioning} versionProcessor 版本号处理器
 * @param {Array.&lt;Object>} files 要处理文件信息列表
 * @return {Object}
 */
exports.generateImgVersion = function (versionProcessor, files) {
    var processImgFiles;

    if (versionProcessor.autoScanImg) {
        processImgFiles = scanResourceFiles(files, versionProcessor.fileSuffix.img);
    }
    else {
        processImgFiles = util.findFileByPath(versionProcessor.imgFilePaths || [], files);
    }

    return util.generateFileMD5Info(processImgFiles, versionProcessor.md5Length);
};

function addFiles(filePaths, target) {
    for (var i = 0, len = filePaths.length; i &lt; len; i++) {
        var f = filePaths[i];
        if (target.indexOf(f) === -1) {
            target.push(f);
        }
    }
}

/**
 * 获取要处理的 css file
 *
 * @inner
 * @param {Versioning} processor 版本号处理器
 * @param {Array.&lt;Object>} files 源文件信息列表
 * @return {Array.&lt;Object>}
 */
function getProcessCSSFiles(processor, files) {
    var cssFiles;
    if (processor.autoScanCss) {
        cssFiles = scanResourceFiles(files, processor.fileSuffix.css);
    }
    else {
        cssFiles = util.findFileByPath(processor.cssFilePaths || [], files);
    }

    return cssFiles;
}

/**
 * 获取要处理的 file
 *
 * @inner
 * @param {Versioning} processor 版本号处理器
 * @param {Array.&lt;Object>} files 源文件信息列表
 * @return {Array.&lt;Object>}
 */
function getProcessFiles(processor, files) {
    var cssFiles = getProcessCSSFiles(processor, files);
    var jsFiles = util.findFileByPath(processor.jsFilePaths || [], files);
    var processFiles = util.findFileByPath(processor.filePaths || [], files);

    addFiles(jsFiles, processFiles);
    addFiles(cssFiles, processFiles);

    return processFiles;
}

/**
 * 获取内联的资源文件要添加的版本号信息，包括 css, js 及其他指定的内联资源文件
 *
 * @param {Versioning} versionProcessor 版本号处理器
 * @param {Array.&lt;Object>} souceFiles 源文件信息列表
 * @return {Object}
 */
exports.generateInlineFileVersion = function (versionProcessor, souceFiles) {
    var processFiles = getProcessFiles(versionProcessor, souceFiles);
    versionProcessor.processInlineFiles = processFiles;

    var versionMap = util.generateFileMD5Info(processFiles, versionProcessor.md5Length);

    // 对于重写文件路径，改写输出的文件路径及引用的 url
    var renameFile = versionProcessor.rename;
    if (renameFile) {
        processFiles.forEach(function (f) {
            var outputPath = f.outputPath;
            f.outputPaths.push(
                versionProcessor.getRenameFilePath(outputPath, versionMap[outputPath])
            );
        });
    }

    if (renameFile) {
        Object.keys(versionMap).forEach(function (k) {
            var version = versionMap[k];
            versionMap[k] = {
                rename: true,
                value: versionProcessor.getRenameFilePath(k, version)
            };
        });
    }

    return versionMap;
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#collectPathVersion">collectPathVersion</a></li><li><a href="global.html#createMd5VersionTree">createMd5VersionTree</a></li><li><a href="global.html#CSS_URL_REGEXP">CSS_URL_REGEXP</a></li><li><a href="global.html#filterRequireFiles">filterRequireFiles</a></li><li><a href="global.html#findFileByPath">findFileByPath</a></li><li><a href="global.html#generateFileMD5Info">generateFileMD5Info</a></li><li><a href="global.html#generateImgVersion">generateImgVersion</a></li><li><a href="global.html#generateInlineFileVersion">generateInlineFileVersion</a></li><li><a href="global.html#getAbsoluteModuleId">getAbsoluteModuleId</a></li><li><a href="global.html#getFileExtName">getFileExtName</a></li><li><a href="global.html#getFileName">getFileName</a></li><li><a href="global.html#getProcessCSSFiles">getProcessCSSFiles</a></li><li><a href="global.html#getProcessFiles">getProcessFiles</a></li><li><a href="global.html#HTTP_URL">HTTP_URL</a></li><li><a href="global.html#isFileTypeMatch">isFileTypeMatch</a></li><li><a href="global.html#isFileTypeOf">isFileTypeOf</a></li><li><a href="global.html#md5sum">md5sum</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#normalizePath">normalizePath</a></li><li><a href="global.html#removePathExtName">removePathExtName</a></li><li><a href="global.html#scanResourceFiles">scanResourceFiles</a></li><li><a href="global.html#stringify">stringify</a></li><li><a href="global.html#VERSION_PLACEHOLDER_REGEXP">VERSION_PLACEHOLDER_REGEXP</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Tue Aug 11 2015 10:54:22 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
