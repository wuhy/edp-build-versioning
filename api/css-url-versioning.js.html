<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: css-url-versioning.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: css-url-versioning.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file 为css url 引用的资源添加版本号信息
 *
 * NOTICE:
 *       对于 `css` 引用的资源如果是以 `http(s):` 协议开头，
 *       会忽略该资源版本号添加
 *
 * @author wuhuiyao
 */

var pathUtil = require('path');
var urlUtil = require('url');
var util = require('./util');

/**
 * 用于提取样式中url属性值里包含的链接
 *
 * @type {RegExp}
 * @const
 */
var CSS_URL_REGEXP = /url\s*\(\s*['"]?\s*([^\s'"\(\)]*)\s*['"]?\s*\)/g;

/**
 * 简单HTTP URL 正则
 *
 * @type {RegExp}
 * @const
 */
var HTTP_URL = /^https?:/;

/**
 * 为 `css` 引用的 url 资源添加版本号信息
 *
 * @param {Versioning} versionProcessor 版本号处理器
 * @param {Array.&lt;Object>} files 要处理文件信息列表
 * @param {Object=} versionMap 要添加的图片资源版本号信息 map，该参数为了兼容已有选项
 */
module.exports = exports = function (versionProcessor, files, versionMap) {
    var cssURL = versionProcessor.cssURL;
    var existedVersionMap;
    var initAllURL;

    if (!cssURL) {
        if (!versionMap || !Object.keys(versionMap).length) {
            return;
        }

        existedVersionMap = versionMap;
    }
    else {
        if (Array.isArray(cssURL)) {
            initAllURL = false;
            existedVersionMap = util.generateFileMD5Info(
                util.findFileByPath(cssURL, files),
                versionProcessor.md5Length
            );
        }
        else {
            initAllURL = true;
            existedVersionMap = {};
        }
    }

    var renameFile = versionProcessor.rename;
    var cssSuffix = versionProcessor.fileSuffix.css;
    var replaceHandler = function (filePath, match, url) {

        // 如果资源 url 为标准的 http(s) url 则不做处理
        if (HTTP_URL.test(url)) {
            return match;
        }

        var processPathInfo = urlUtil.parse(util.normalizePath(
            pathUtil.join(pathUtil.dirname(filePath), url)
        ));
        var processPath = processPathInfo.pathname;
        var version = existedVersionMap[processPath];

        if (!version &amp;&amp; initAllURL) {
            var foundFile = util.findFileByPath(processPath, files);
            version = foundFile &amp;&amp; util.md5sum(foundFile, versionProcessor.md5Length);
            existedVersionMap[processPath] = version;
        }

        if (!version) {
            return match;
        }

        var hashIdx = url.lastIndexOf('#');
        var hash = hashIdx > 0 ? url.substr(hashIdx) : '';
        var noHashUrl = hashIdx > 0 ? url.substr(0, hashIdx) : url;
        var queryIdx = noHashUrl.indexOf('?');
        var prefix = queryIdx > 0 ? '&amp;' : '?';

        // 如果只有一个 `?`, 则啥都不加
        (queryIdx === noHashUrl.length - 1) &amp;&amp; (prefix = '');

        // 如果不是重写输入文件路径，直接加md5版本号作为查询参数
        if (!renameFile) {
            return match.replace(url, noHashUrl + prefix + version + hash);
        }

        // 重写输出的文件路径
        var processFile = util.findFileByPath(processPath, files);
        if (!processFile.get('md5renamed')) {
            processFile.outputPaths.push(
                versionProcessor.getRenameFilePath(processFile.outputPath, version)
            );
            processFile.set('md5renamed', 1);
        }

        var fileName = util.getFileName(processPath, true);
        return match.replace(
            fileName, versionProcessor.getRenameFilePath(fileName, version)
        );
    };

    for (var i = 0, len = files.length; i &lt; len; i++) {
        var file = files[i];
        var extname = file.extname;

        if (util.isFileTypeOf(extname, cssSuffix)) {
            var filePath = file.path;
            file.data = file.data.replace(
                CSS_URL_REGEXP, replaceHandler.bind(this, filePath)
            );
        }
    }
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#collectPathVersion">collectPathVersion</a></li><li><a href="global.html#createMd5VersionTree">createMd5VersionTree</a></li><li><a href="global.html#CSS_URL_REGEXP">CSS_URL_REGEXP</a></li><li><a href="global.html#filterRequireFiles">filterRequireFiles</a></li><li><a href="global.html#findFileByPath">findFileByPath</a></li><li><a href="global.html#generateFileMD5Info">generateFileMD5Info</a></li><li><a href="global.html#generateImgVersion">generateImgVersion</a></li><li><a href="global.html#generateInlineFileVersion">generateInlineFileVersion</a></li><li><a href="global.html#getAbsoluteModuleId">getAbsoluteModuleId</a></li><li><a href="global.html#getFileExtName">getFileExtName</a></li><li><a href="global.html#getFileName">getFileName</a></li><li><a href="global.html#getProcessCSSFiles">getProcessCSSFiles</a></li><li><a href="global.html#getProcessFiles">getProcessFiles</a></li><li><a href="global.html#HTTP_URL">HTTP_URL</a></li><li><a href="global.html#isFileTypeMatch">isFileTypeMatch</a></li><li><a href="global.html#isFileTypeOf">isFileTypeOf</a></li><li><a href="global.html#md5sum">md5sum</a></li><li><a href="global.html#mixin">mixin</a></li><li><a href="global.html#normalizePath">normalizePath</a></li><li><a href="global.html#removePathExtName">removePathExtName</a></li><li><a href="global.html#scanResourceFiles">scanResourceFiles</a></li><li><a href="global.html#stringify">stringify</a></li><li><a href="global.html#VERSION_PLACEHOLDER_REGEXP">VERSION_PLACEHOLDER_REGEXP</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Tue Aug 11 2015 10:54:22 GMT+0800 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
